generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "public")]
}

model user_memory {
  id          String    @id @default(uuid())
  user_id     String    @db.VarChar(255)
  session_id  String?   @db.VarChar(255)
  memory_type String    @db.VarChar(50)
  content     String
  embedding   Json?
  metadata    Json?
  vctt_score  Decimal?  @db.Decimal(5, 2)
  created_at  DateTime  @default(now()) @db.Timestamp(6)
  updated_at  DateTime  @updatedAt @db.Timestamp(6)
  expires_at  DateTime? @db.Timestamp(6)

  @@index([user_id], map: "idx_user_id")
  @@index([session_id], map: "idx_session_id")
  @@index([created_at], map: "idx_created_at")
  @@map("user_memory")
}

model memory_consent {
  id              String    @id @default(uuid())
  user_id         String    @unique @db.VarChar(255)
  consent_given   Boolean   @default(false)
  consent_date    DateTime? @db.Timestamp(6)
  consent_version String?   @db.VarChar(20)
  preferences     Json?
  created_at      DateTime  @default(now()) @db.Timestamp(6)
  updated_at      DateTime  @updatedAt @db.Timestamp(6)

  @@map("memory_consent")
}

model memory_audit {
  id                String   @id @default(uuid())
  user_id           String   @db.VarChar(255)
  operation         String   @db.VarChar(50)
  memory_id         String?  @db.VarChar(255)
  reason            String?
  vctt_verification Boolean  @default(false)
  timestamp         DateTime @default(now()) @db.Timestamp(6)
  metadata          Json?

  @@index([user_id], map: "idx_audit_user_id")
  @@index([timestamp], map: "idx_audit_timestamp")
  @@map("memory_audit")
}

model kg_entity {
  id                 String               @id @default(uuid())
  user_id            String               @db.VarChar(255)
  name               String               @db.VarChar(500)
  type               String               @db.VarChar(100)
  description        String?
  attributes         Json?
  embedding          Json?
  vctt_score         Decimal              @db.Decimal(5, 2)
  confidence         Decimal              @db.Decimal(5, 2)
  first_mentioned    DateTime             @default(now()) @db.Timestamp(6)
  last_updated       DateTime             @updatedAt @db.Timestamp(6)
  source_memory_id   String?              @db.VarChar(255)
  concept_mappings   kg_concept_mapping[]
  relationships_from kg_relationship[]    @relation("FromEntity")
  relationships_to   kg_relationship[]    @relation("ToEntity")

  @@index([user_id], map: "idx_entity_user_id")
  @@index([type], map: "idx_entity_type")
  @@index([name], map: "idx_entity_name")
  @@index([vctt_score], map: "idx_entity_vctt")
  @@map("kg_entity")
}

model kg_relationship {
  id               String    @id @default(uuid())
  user_id          String    @db.VarChar(255)
  from_entity_id   String    @db.VarChar(255)
  to_entity_id     String    @db.VarChar(255)
  relation_type    String    @db.VarChar(100)
  properties       Json?
  vctt_score       Decimal   @db.Decimal(5, 2)
  confidence       Decimal   @db.Decimal(5, 2)
  created_at       DateTime  @default(now()) @db.Timestamp(6)
  updated_at       DateTime  @updatedAt @db.Timestamp(6)
  source_memory_id String?   @db.VarChar(255)
  from_entity      kg_entity @relation("FromEntity", fields: [from_entity_id], references: [id], onDelete: Cascade)
  to_entity        kg_entity @relation("ToEntity", fields: [to_entity_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_rel_user_id")
  @@index([from_entity_id], map: "idx_rel_from")
  @@index([to_entity_id], map: "idx_rel_to")
  @@index([relation_type], map: "idx_rel_type")
  @@map("kg_relationship")
}

model kg_concept {
  id              String               @id @default(uuid())
  name            String               @unique @db.VarChar(255)
  description     String?
  parent_id       String?              @db.VarChar(255)
  level           Int                  @default(0)
  embedding       Json?
  vctt_score      Decimal              @db.Decimal(5, 2)
  created_at      DateTime             @default(now()) @db.Timestamp(6)
  updated_at      DateTime             @updatedAt @db.Timestamp(6)
  parent          kg_concept?          @relation("ConceptHierarchy", fields: [parent_id], references: [id])
  children        kg_concept[]         @relation("ConceptHierarchy")
  entity_mappings kg_concept_mapping[]

  @@index([parent_id], map: "idx_concept_parent")
  @@index([name], map: "idx_concept_name")
  @@map("kg_concept")
}

model kg_concept_mapping {
  id         String     @id @default(uuid())
  entity_id  String     @db.VarChar(255)
  concept_id String     @db.VarChar(255)
  relevance  Decimal    @db.Decimal(5, 2)
  concept    kg_concept @relation(fields: [concept_id], references: [id], onDelete: Cascade)
  entity     kg_entity  @relation(fields: [entity_id], references: [id], onDelete: Cascade)

  @@unique([entity_id, concept_id])
  @@index([entity_id], map: "idx_mapping_entity")
  @@index([concept_id], map: "idx_mapping_concept")
  @@map("kg_concept_mapping")
}

model conversations {
  id                String              @id(map: "PK_ee34f4f7ced4ec8681f26bf04ef") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id           String              @db.VarChar
  created_at        DateTime            @default(now()) @db.Timestamp(6)
  llm_contributions llm_contributions[]
  messages          messages[]
}

model internal_state {
  session_id String   @id(map: "PK_0135e9060b31d4a0397441de11f") @db.VarChar
  state      Json
  updated_at DateTime @default(now()) @db.Timestamp(6)
}

model llm_contributions {
  id            String        @id(map: "PK_5eba03517c944055c2b6f9a3341") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  session_id    String        @db.Uuid
  message_id    String?       @db.Uuid
  model_name    String        @db.VarChar(50)
  agent_name    String        @db.VarChar(50)
  contributed   Boolean       @default(false)
  offline       Boolean       @default(false)
  error_type    String?       @db.VarChar(100)
  tokens_used   Int           @default(0)
  cost_usd      Decimal       @default(0) @db.Decimal(10, 6)
  latency_ms    Int           @default(0)
  timestamp     DateTime      @default(now()) @db.Timestamp(6)
  messages      messages?     @relation(fields: [message_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_19148d557b8ae35424f44bf954b")
  conversations conversations @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_ece56b059987dbca919f3af0e8f")
}

model messages {
  id                String              @id(map: "PK_18325f38ae6de43878487eff986") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversation_id   String              @db.Uuid
  role              String              @db.VarChar
  content           String
  timestamp         DateTime            @default(now()) @db.Timestamp(6)
  model             String?             @db.VarChar
  tokens_input      Int?
  tokens_output     Int?
  tokens_total      Int?
  cost_usd          Decimal?            @db.Decimal(10, 6)
  latency_ms        Int?
  llm_contributions llm_contributions[]
  conversations     conversations       @relation(fields: [conversation_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_3bc55a7c3f9ed54b520bb5cfe23")
}

// ============================================
// STAGE 3: GOAL SYSTEM SCHEMA
// Self-aware goal tracking, hierarchy, and state management
// ============================================

// Goals Table (Core)
model goals {
  id                  Int         @id @default(autoincrement())
  title               String      @db.VarChar(255)
  description         String?     @db.Text
  status              String      @default("proposed") @db.VarChar(50) // proposed, active, paused, completed, abandoned
  priority            Int         @default(3) // 1 (lowest) to 5 (highest)
  owner               String      @db.VarChar(100) // human, system, min
  parent_goal_id      Int?
  created_by          String      @db.VarChar(100)
  created_at          DateTime    @default(now()) @db.Timestamp(6)
  updated_at          DateTime    @updatedAt @db.Timestamp(6)
  completed_at        DateTime?   @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  // Relations
  parent_goal         goals?      @relation("GoalHierarchy", fields: [parent_goal_id], references: [id], onDelete: Cascade)
  child_goals         goals[]     @relation("GoalHierarchy")
  constraints         goal_constraints[]
  progress_entries    goal_progress[]
  audit_entries       goal_audit[]
  activity_logs       goal_activity_logs[]
  subtasks            goal_subtasks[]
  artifacts           goal_artifacts[]
  scheduled_tasks     scheduled_tasks[] @relation("TaskGoals")
  tool_invocations    tool_invocations[] @relation("InvocationGoals")
  autonomy_audits     autonomy_audit[] @relation("AuditGoals")
  evaluations         evaluations[]
  
  @@index([status], name: "idx_goals_status")
  @@index([owner], name: "idx_goals_owner")
  @@index([priority], name: "idx_goals_priority")
  @@index([parent_goal_id], name: "idx_goals_parent")
  @@map("goals")
}

// Goal Constraints Table
model goal_constraints {
  id                  Int         @id @default(autoincrement())
  goal_id             Int
  constraint_type     String      @db.VarChar(50) // dependency, resource, time, safety
  constraint_value    String      @db.Text
  is_blocking         Boolean     @default(false)
  created_at          DateTime    @default(now()) @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  // Relations
  goal                goals       @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  
  @@index([goal_id], name: "idx_goal_constraints_goal")
  @@map("goal_constraints")
}

// Goal Progress Table
model goal_progress {
  id                  Int         @id @default(autoincrement())
  goal_id             Int
  progress_percent    Int         @default(0) // 0-100
  milestone           String?     @db.VarChar(255)
  notes               String?     @db.Text
  recorded_by         String      @db.VarChar(100)
  recorded_at         DateTime    @default(now()) @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  // Relations
  goal                goals       @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  
  @@index([goal_id], name: "idx_goal_progress_goal")
  @@map("goal_progress")
}

// Goal Audit Table (Full Transparency)
model goal_audit {
  id                  Int         @id @default(autoincrement())
  goal_id             Int
  action              String      @db.VarChar(50) // created, activated, paused, completed, abandoned, updated
  actor               String      @db.VarChar(100)
  reason              String?     @db.Text
  before_state        Json?       @db.JsonB
  after_state         Json?       @db.JsonB
  timestamp           DateTime    @default(now()) @db.Timestamp(6)
  regulation_mode     String?     @db.VarChar(50)
  metadata            Json?       @db.JsonB
  
  // Relations
  goal                goals       @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  
  @@index([goal_id], name: "idx_goal_audit_goal")
  @@index([timestamp], name: "idx_goal_audit_timestamp")
  @@map("goal_audit")
}

// Goal Activity Logs - Real-time activity tracking
model goal_activity_logs {
  id                  Int         @id @default(autoincrement())
  goal_id             Int
  actor               String      @db.VarChar(100) // min, human, system
  activity_type       String      @db.VarChar(50) // started, progress, completed, question, blocked, subtask_created
  message             String      @db.Text
  metadata            Json?       @db.JsonB
  created_at          DateTime    @default(now()) @db.Timestamp(6)
  
  // Relations
  goal                goals       @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  
  @@index([goal_id], name: "idx_activity_logs_goal")
  @@index([created_at], name: "idx_activity_logs_timestamp")
  @@index([actor], name: "idx_activity_logs_actor")
  @@map("goal_activity_logs")
}

// Goal Subtasks - MIN's decomposed tasks
model goal_subtasks {
  id                  Int         @id @default(autoincrement())
  goal_id             Int
  title               String      @db.VarChar(500)
  description         String?     @db.Text
  status              String      @default("pending") @db.VarChar(50) // pending, in_progress, completed, blocked
  order_index         Int         @default(0)
  estimated_effort    String?     @db.VarChar(50) // low, medium, high
  created_by          String      @default("min") @db.VarChar(100)
  completed_at        DateTime?   @db.Timestamp(6)
  created_at          DateTime    @default(now()) @db.Timestamp(6)
  updated_at          DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  // Relations
  goal                goals       @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  
  @@index([goal_id], name: "idx_subtasks_goal")
  @@index([status], name: "idx_subtasks_status")
  @@map("goal_subtasks")
}

// Goal Artifacts - Completed builds, outputs, deliverables
model goal_artifacts {
  id                  Int         @id @default(autoincrement())
  goal_id             Int
  artifact_type       String      @db.VarChar(50) // code, url, file, screenshot, document, deployment
  artifact_name       String      @db.VarChar(500)
  artifact_description String?    @db.Text
  artifact_path       String?     @db.Text // File path or URL
  artifact_data       String?     @db.Text // Small inline content (code snippets, JSON, etc.)
  file_size           Int?        // Size in bytes
  mime_type           String?     @db.VarChar(100)
  metadata            Json?       @db.JsonB // Additional metadata (language, framework, etc.)
  created_at          DateTime    @default(now()) @db.Timestamp(6)
  created_by          String      @default("min") @db.VarChar(100)
  
  // Relations
  goal                goals       @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  
  @@index([goal_id], name: "idx_artifacts_goal")
  @@index([artifact_type], name: "idx_artifacts_type")
  @@index([created_at], name: "idx_artifacts_created")
  @@map("goal_artifacts")
}

// Execution State - Track MIN's execution loop
model execution_state {
  id                  Int         @id @default(autoincrement())
  is_running          Boolean     @default(false)
  current_goal_id     Int?
  started_at          DateTime?   @db.Timestamp(6)
  stopped_at          DateTime?   @db.Timestamp(6)
  total_goals_processed Int       @default(0)
  total_subtasks_completed Int    @default(0)
  last_heartbeat      DateTime?   @db.Timestamp(6)
  error_message       String?     @db.Text
  updated_at          DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  @@map("execution_state")
}

// ═══════════════════════════════════════════════════════════
// STAGE 4: CONSTRAINED AUTONOMY & SELF-IMPROVEMENT
// ═══════════════════════════════════════════════════════════

// Scheduled Tasks - Deferred/Periodic/Reminder execution
model scheduled_tasks {
  id                  Int         @id @default(autoincrement())
  title               String      @db.VarChar(255)
  description         String?     @db.Text
  task_type           String      @db.VarChar(50)
  scheduled_at        DateTime    @db.Timestamp(6)
  cron_expression     String?     @db.VarChar(100)
  timezone            String      @default("UTC") @db.VarChar(50)
  status              String      @default("pending") @db.VarChar(50)
  priority            Int         @default(3)
  timeout_seconds     Int         @default(300)
  max_retries         Int         @default(3)
  retry_count         Int         @default(0)
  tool_name           String      @db.VarChar(100)
  tool_params         Json        @db.JsonB
  goal_id             Int?
  created_by          String      @db.VarChar(100)
  requires_approval   Boolean     @default(false)
  approved_by         String?     @db.VarChar(100)
  approved_at         DateTime?   @db.Timestamp(6)
  started_at          DateTime?   @db.Timestamp(6)
  completed_at        DateTime?   @db.Timestamp(6)
  result              Json?       @db.JsonB
  error               String?     @db.Text
  created_at          DateTime    @default(now()) @db.Timestamp(6)
  updated_at          DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  goal                goals?      @relation("TaskGoals", fields: [goal_id], references: [id], onDelete: Cascade)
  tool_invocations    tool_invocations[]
  autonomy_audits     autonomy_audit[]
  
  @@index([scheduled_at])
  @@index([status])
  @@index([goal_id])
  @@index([created_by])
  @@map("scheduled_tasks")
}

// Tool Invocations - Complete audit log
model tool_invocations {
  id                  Int         @id @default(autoincrement())
  tool_name           String      @db.VarChar(100)
  tool_version        String      @default("1.0.0") @db.VarChar(20)
  session_id          String?     @db.VarChar(255)
  goal_id             Int?
  task_id             Int?
  invoked_by          String      @db.VarChar(100)
  invoked_at          DateTime    @default(now()) @db.Timestamp(6)
  why                 String      @db.Text
  params              Json        @db.JsonB
  started_at          DateTime?   @db.Timestamp(6)
  completed_at        DateTime?   @db.Timestamp(6)
  duration_ms         Int?
  status              String      @db.VarChar(50)
  result              Json?       @db.JsonB
  error               String?     @db.Text
  regulation_mode     String      @db.VarChar(50)
  permission_level    String      @db.VarChar(50)
  blocked             Boolean     @default(false)
  block_reason        String?     @db.Text
  metadata            Json?       @db.JsonB
  
  goal                goals?      @relation("InvocationGoals", fields: [goal_id], references: [id], onDelete: SetNull)
  task                scheduled_tasks? @relation(fields: [task_id], references: [id], onDelete: SetNull)
  autonomy_audits     autonomy_audit[]
  
  @@index([tool_name])
  @@index([invoked_by])
  @@index([status])
  @@index([goal_id])
  @@index([invoked_at])
  @@map("tool_invocations")
}

// Evaluations - Self-improvement data
model evaluations {
  id                  Int         @id @default(autoincrement())
  goal_id             Int?
  episode_id          String?     @db.VarChar(255)
  session_id          String      @db.VarChar(255)
  episode_type        String      @db.VarChar(50)
  
  // Trust metrics (tau)
  tau_start           Float?
  tau_end             Float?
  tau_delta           Float?
  trust_tau           Float       // Overall trust score
  
  // Performance metrics
  latency_ms          Int
  cost_usd            Float?
  success_score       Int?        // 0-100
  success             Boolean
  
  // Human feedback
  human_rating        Int?        // 1-5
  human_feedback      String?     @db.Text
  
  // Quality metrics
  contradiction_count Int         @default(0)
  repair_count        Int         @default(0)
  tool_calls_count    Int         @default(0)
  
  // Execution data
  models_used         Json?       @db.JsonB
  tools_used          Json?       @db.JsonB
  planner_reasoning   String?     @db.Text
  
  // Outcome
  error_type          String?     @db.VarChar(100)
  instruction         String?     @db.Text
  response_summary    String?     @db.Text
  
  // Timestamps
  evaluated_at        DateTime    @default(now()) @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  // Relations
  goal                goals?      @relation(fields: [goal_id], references: [id], onDelete: SetNull)
  
  @@index([goal_id])
  @@index([session_id])
  @@index([episode_type])
  @@index([evaluated_at])
  @@index([trust_tau])
  @@index([tau_delta])
  @@index([success])
  @@index([success_score])
  @@map("evaluations")
}

// Coach Proposals - Never auto-applied
model coach_proposals {
  id                      Int         @id @default(autoincrement())
  title                   String      @db.VarChar(255)
  proposal_type           String      @db.VarChar(50)
  analysis_summary        String      @db.Text
  sample_size             Int
  confidence_score        Float
  current_behavior        String?     @db.Text
  proposed_behavior       String      @db.Text
  expected_improvement    String      @db.Text
  supporting_evaluations  Json?       @db.JsonB
  metrics                 Json?       @db.JsonB
  status                  String      @default("pending") @db.VarChar(50)
  reviewed_by             String?     @db.VarChar(100)
  reviewed_at             DateTime?   @db.Timestamp(6)
  review_notes            String?     @db.Text
  testing_started_at      DateTime?   @db.Timestamp(6)
  testing_ended_at        DateTime?   @db.Timestamp(6)
  test_results            Json?       @db.JsonB
  implemented_at          DateTime?   @db.Timestamp(6)
  implementation_notes    String?     @db.Text
  created_at              DateTime    @default(now()) @db.Timestamp(6)
  updated_at              DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  metadata                Json?       @db.JsonB
  
  @@index([status])
  @@index([proposal_type])
  @@index([created_at])
  @@map("coach_proposals")
}

// Skills - Proven pattern library
model skills {
  id                          Int         @id @default(autoincrement())
  skill_name                  String      @unique @db.VarChar(100)
  skill_version               String      @default("1.0.0") @db.VarChar(20)
  category                    String      @db.VarChar(50)
  title                       String      @db.VarChar(255)
  description                 String      @db.Text
  use_cases                   String[]
  prompt_template             String      @db.Text
  required_context            String[]
  required_tools              String[]
  success_rate                Float?
  avg_trust_tau               Float?
  avg_latency_ms              Int?
  usage_count                 Int         @default(0)
  extracted_from_evaluation_ids Json?     @db.JsonB
  last_refined_at             DateTime?   @db.Timestamp(6)
  refinement_notes            String?     @db.Text
  status                      String      @default("active") @db.VarChar(50)
  approved_by                 String      @db.VarChar(100)
  approved_at                 DateTime    @default(now()) @db.Timestamp(6)
  created_at                  DateTime    @default(now()) @db.Timestamp(6)
  updated_at                  DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  metadata                    Json?       @db.JsonB
  
  @@index([skill_name])
  @@index([category])
  @@index([status])
  @@index([success_rate])
  @@map("skills")
}

// Tool Registry - Standardized tool definitions
model tool_registry {
  id                    Int         @id @default(autoincrement())
  tool_name             String      @unique @db.VarChar(100)
  tool_version          String      @default("1.0.0") @db.VarChar(20)
  description           String      @db.Text
  input_schema          Json        @db.JsonB
  output_schema         Json        @db.JsonB
  min_regulation_mode   String      @db.VarChar(50)
  requires_approval     Boolean     @default(false)
  sandbox_only          Boolean     @default(false)
  rate_limit_per_minute Int         @default(60)
  rate_limit_per_hour   Int         @default(1000)
  status                String      @default("active") @db.VarChar(50)
  created_at            DateTime    @default(now()) @db.Timestamp(6)
  updated_at            DateTime    @default(now()) @updatedAt @db.Timestamp(6)
  metadata              Json?       @db.JsonB
  
  @@index([tool_name])
  @@index([status])
  @@map("tool_registry")
}

// Autonomy Audit - High-level oversight
model autonomy_audit {
  id                  Int         @id @default(autoincrement())
  event_type          String      @db.VarChar(50)
  actor               String      @db.VarChar(100)
  regulation_mode     String      @db.VarChar(50)
  goal_id             Int?
  task_id             Int?
  tool_invocation_id  Int?
  details             Json        @db.JsonB
  risk_level          String?     @db.VarChar(20)
  outcome             String?     @db.VarChar(50)
  block_reason        String?     @db.Text
  recorded_at         DateTime    @default(now()) @db.Timestamp(6)
  metadata            Json?       @db.JsonB
  
  goal                goals?      @relation("AuditGoals", fields: [goal_id], references: [id], onDelete: SetNull)
  task                scheduled_tasks? @relation(fields: [task_id], references: [id], onDelete: SetNull)
  tool_invocation     tool_invocations? @relation(fields: [tool_invocation_id], references: [id], onDelete: SetNull)
  
  @@index([event_type])
  @@index([actor])
  @@index([recorded_at])
  @@index([outcome])
  @@map("autonomy_audit")
}
